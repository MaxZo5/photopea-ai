<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AI Photopea Assistant</title>
    <style>
        /* ØªØµÙ…ÙŠÙ… ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØªÙˆØ¨ÙŠØ§ Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
        body {
            background-color: #353535;
            color: #eeeeee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 15px;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        h3 { margin-top: 0; color: #4fd1c5; text-align: center; }
        
        .setup-box {
            background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        
        input, textarea, select {
            width: 100%;
            background: #444;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #4fd1c5;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }
        button:hover { background: #38b2ac; }
        button:disabled { background: #555; cursor: not-allowed; }

        #chat-log {
            flex-grow: 1;
            background: #222;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid #444;
        }

        .msg { margin-bottom: 8px; padding: 5px; border-radius: 4px; }
        .user { color: #4fd1c5; }
        .ai { color: #ebf8ff; }
        .system { color: #aaa; font-style: italic; font-size: 11px; }

        /* Ù„ØªØ­Ù…ÙŠÙ„ (Spinner) Ø¨Ø³ÙŠØ· */
        .loading { text-align: center; display: none; }
    </style>
</head>
<body>

    <h3>Photopea AI Agent</h3>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
    <div class="setup-box">
        <label style="font-size: 12px;">Google Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ù‡Ù†Ø§...">
    </div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="chat-log">
        <div class="system">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. Ø§Ø·Ù„Ø¨ Ù…Ù†ÙŠ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©.</div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <textarea id="promptInput" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙˆØ§ÙƒØªØ¨ 'Ù…Ø±Ø­Ø¨Ø§Ù‹' Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±"></textarea>
    <button onclick="handleRequest()" id="sendBtn">Ù†ÙØ° Ø§Ù„Ø£Ù…Ø± ğŸš€</button>
    <div class="loading" id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯... â³</div>

    <script>
        // 1. Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠ (System Prompt)
        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø£Ù‡Ù… Ø¬Ø²Ø¡ØŒ Ù‡Ù†Ø§ Ù†Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙƒÙŠÙ ÙŠØªØµØ±Ù
  <script>
        const SYSTEM_PROMPT = `
        You are an expert Photopea scripter. 
        Output ONLY valid JavaScript code for Photopea. 
        No markdown, no explanations. 
        Example: app.activeDocument.artLayers.add();
        `;

        function log(text, type) {
            const logDiv = document.getElementById('chat-log');
            const msg = document.createElement('div');
            msg.className = 'msg ' + type;
            msg.innerText = (type === 'user' ? 'Ø£Ù†Øª: ' : 'AI: ') + text;
            logDiv.appendChild(msg);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function runPhotopeaScript(code) {
            let cleanCode = code.replace(/```javascript/g, "").replace(/```/g, "").trim();
            window.parent.postMessage(cleanCode, "*");
        }

        async function handleRequest() {
            const input = document.getElementById('promptInput');
            const apiKey = document.getElementById('apiKey').value;
            const btn = document.getElementById('sendBtn');
            const loader = document.getElementById('loader');

            if (!input.value || !apiKey) {
                alert("ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø·Ù„Ø¨Ùƒ ÙˆÙˆØ¶Ø¹ API Key");
                return;
            }

            const userText = input.value;
            log(userText, 'user');
            input.value = '';
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ gemini-1.5-flash ÙˆÙ‡Ùˆ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ø­Ø§Ù„ÙŠØ§Ù‹
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: SYSTEM_PROMPT + "\n\nUser: " + userText }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                runPhotopeaScript(aiResponse);
                log("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…", 'system');

            } catch (error) {
                log("Ø®Ø·Ø£: " + error.message, 'system');
                console.error(error);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
