<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AI Photopea Assistant</title>
    <style>
        /* ØªØµÙ…ÙŠÙ… ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØªÙˆØ¨ÙŠØ§ Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
        body {
            background-color: #353535;
            color: #eeeeee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 15px;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        h3 { margin-top: 0; color: #4fd1c5; text-align: center; }
        
        .setup-box {
            background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        
        input, textarea, select {
            width: 100%;
            background: #444;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #4fd1c5;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }
        button:hover { background: #38b2ac; }
        button:disabled { background: #555; cursor: not-allowed; }

        #chat-log {
            flex-grow: 1;
            background: #222;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid #444;
        }

        .msg { margin-bottom: 8px; padding: 5px; border-radius: 4px; }
        .user { color: #4fd1c5; }
        .ai { color: #ebf8ff; }
        .system { color: #aaa; font-style: italic; font-size: 11px; }

        /* Ù„ØªØ­Ù…ÙŠÙ„ (Spinner) Ø¨Ø³ÙŠØ· */
        .loading { text-align: center; display: none; }
    </style>
</head>
<body>

    <h3>Photopea AI Agent</h3>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
    <div class="setup-box">
        <label style="font-size: 12px;">Google Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ù‡Ù†Ø§...">
    </div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="chat-log">
        <div class="system">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. Ø§Ø·Ù„Ø¨ Ù…Ù†ÙŠ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©.</div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <textarea id="promptInput" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙˆØ§ÙƒØªØ¨ 'Ù…Ø±Ø­Ø¨Ø§Ù‹' Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±"></textarea>
    <button onclick="handleRequest()" id="sendBtn">Ù†ÙØ° Ø§Ù„Ø£Ù…Ø± ğŸš€</button>
    <div class="loading" id="loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯... â³</div>

    <script>
        // 1. Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ù‡Ø¨ÙŠ (System Prompt)
        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø£Ù‡Ù… Ø¬Ø²Ø¡ØŒ Ù‡Ù†Ø§ Ù†Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙƒÙŠÙ ÙŠØªØµØ±Ù
        const SYSTEM_PROMPT = `
        You are an expert Adobe Photoshop/Photopea scripter.
        The user will give you a natural language command.
        You must output ONLY valid JavaScript (ExtendScript) code compatible with Photopea.
        
        RULES:
        1. Do NOT write markdown (no \`\`\`javascript).
        2. Do NOT write explanations. Just the code.
        3. Use 'app.activeDocument' to target the image.
        4. If creating text, make sure to set the size large enough to be visible (e.g., 50px).
        5. If the user asks for something impossible via script, use 'alert("Cannot do that");'.
        `;

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø´Ø§Øª
        function log(text, type) {
            const logDiv = document.getElementById('chat-log');
            const msg = document.createElement('div');
            msg.className = 'msg ' + type;
            msg.innerText = (type === 'user' ? 'Ø£Ù†Øª: ' : 'AI: ') + text;
            logDiv.appendChild(msg);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Photopea (Ø§Ù„Ø¬Ø³Ø±)
        function runPhotopeaScript(code) {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Markdown Ù‚Ø¯ ÙŠØ¶ÙŠÙÙ‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø®Ø·Ø£Ù‹
            let cleanCode = code.replace(/```javascript/g, "").replace(/```/g, "").trim();
            
            console.log("Executing:", cleanCode); // Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù… (Photopea)
            window.parent.postMessage(cleanCode, "*");
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Gemini Example)
        async function handleRequest() {
            const input = document.getElementById('promptInput');
            const apiKey = document.getElementById('apiKey').value;
            const btn = document.getElementById('sendBtn');
            const loader = document.getElementById('loader');

            if (!input.value) return;
            if (!apiKey) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ API Key Ø£ÙˆÙ„Ø§Ù‹"); return; }

            const userText = input.value;
            log(userText, 'user');
            input.value = '';
            
            // ØªÙØ¹ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù€ Google Gemini API
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: SYSTEM_PROMPT + "\n\nUser Request: " + userText
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø±Ø¯
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                log("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...", 'system');
                
                // ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ÙÙˆØªÙˆØ¨ÙŠØ§
                runPhotopeaScript(aiResponse);

            } catch (error) {
                log("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message, 'system');
                alert("Error: " + error.message);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
