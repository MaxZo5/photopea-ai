<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photopea AI Agent - Ù…Ø­Ø³Ù†</title>
    <style>
        :root {
            --bg-dark: #181818;
            --bg-panel: #2b2b2b;
            --accent: #4fd1c5; /* Ù„ÙˆÙ† ÙÙˆØªÙˆØ¨ÙŠØ§ Ø§Ù„Ù…Ù…ÙŠØ² */
            --accent-hover: #38b2ac;
            --text-main: #eeeeee;
            --text-dim: #aaaaaa;
            --border: #444;
            --code-bg: #1e1e1e;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 95vh;
            box-sizing: border-box;
        }

        h3 {
            margin: 0 0 15px 0;
            color: var(--accent);
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-panel {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group {
            flex-grow: 1;
        }

        label {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        input[type="password"], input[type="text"] {
            width: 100%;
            background: #111;
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            box-sizing: border-box;
            outline: none;
        }

        input:focus { border-color: var(--accent); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„ÙƒÙˆØ¯ */
        .main-interface {
            display: flex;
            flex-grow: 1;
            gap: 15px;
            min-height: 0; /* Ù…Ù‡Ù… Ù„Ù„ÙÙ„ÙŠÙƒØ³ */
        }

        /* Ø§Ù„Ø´Ø§Øª */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        #chat-log {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .msg { margin-bottom: 12px; padding: 8px 12px; border-radius: 6px; max-width: 85%; }
        .user { 
            background-color: #3a3a3a; 
            color: var(--text-main); 
            align-self: flex-start; 
            border-right: 3px solid var(--accent);
        }
        .ai { 
            background-color: #2c4c47; 
            color: #e6fffa; 
            align-self: flex-end; 
            text-align: left; /* Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ */
            direction: ltr; 
            border-left: 3px solid var(--accent);
            font-family: monospace;
            font-size: 12px;
        }
        .system { 
            color: var(--text-dim); 
            font-size: 12px; 
            text-align: center; 
            margin: 10px 0;
            font-style: italic;
        }

        .input-area {
            padding: 10px;
            background: #222;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        textarea {
            flex-grow: 1;
            background: #111;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 4px;
            resize: none;
            height: 50px;
            font-family: inherit;
        }
        
        textarea:focus { outline: none; border-color: var(--accent); }

        button {
            padding: 0 20px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        button:hover { background: var(--accent-hover); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* Ù…Ø­Ø±Ø± Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©) */
        .code-preview-section {
            width: 40%;
            background: var(--code-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 10px;
            background: #252526;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #code-output {
            flex-grow: 1;
            padding: 15px;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }

        .run-btn {
            background: #4caf50;
            color: white;
            width: 100%;
            padding: 12px;
            border-radius: 0 0 8px 8px;
            font-weight: bold;
        }
        .run-btn:hover { background: #43a047; }

        /* Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© */
        .copy-btn {
            background: transparent;
            color: #aaa;
            font-size: 11px;
            padding: 4px;
            width: auto;
        }
        .copy-btn:hover { color: white; background: rgba(255,255,255,0.1); }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-left: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            font-size: 14px;
        }
        #toast.show { opacity: 1; }

        @media (max-width: 768px) {
            .main-interface { flex-direction: column; }
            .code-preview-section { width: 100%; height: 200px; }
        }
    </style>
</head>
<body>

    <h3>ğŸ¤– Photopea AI Agent</h3>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ -->
    <div class="settings-panel">
        <div class="input-group">
            <label>Google Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ù‡Ù†Ø§ (AIza...)" autocomplete="off">
        </div>
        <button onclick="saveKey()" style="width: auto; margin-top: 18px;">Ø­ÙØ¸</button>
    </div>

    <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="main-interface">
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div class="chat-section">
            <div id="chat-log">
                <div class="system">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø®Ø§Øµ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Photopea.</div>
                <div class="system">Ø£Ø®Ø¨Ø±Ù†ÙŠ Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ (Ù…Ø«Ø§Ù„: "Ø£Ù†Ø´Ø¦ Ù…Ø³ØªÙ†Ø¯Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ø£Ø¨Ø¹Ø§Ø¯ 800x600 ÙˆØ£Ø¶Ù Ø¯Ø§Ø¦Ø±Ø© Ø²Ø±Ù‚Ø§Ø¡").</div>
            </div>
            <div class="input-area">
                <textarea id="promptInput" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§..."></textarea>
                <button id="sendBtn" onclick="handleRequest()">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒÙˆØ¯ -->
        <div class="code-preview-section">
            <div class="panel-header">
                <span>JavaScript Code (Photopea API)</span>
                <button class="copy-btn" onclick="copyCode()">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
            </div>
            <div id="code-output">// Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù‡Ù†Ø§...</div>
            <button class="run-btn" onclick="runPhotopeaScript()" id="runBtn" disabled>ØªÙ†ÙÙŠØ° ÙÙŠ Photopea â–¶</button>
        </div>

    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†Ø¨Ø«Ù‚ -->
    <div id="toast">ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!</div>

    <script>
        // ============================================================
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (System Prompt) - Ø§Ù„Ø¯Ù…Ø§Øº Ø§Ù„Ù…Ø¯Ø¨Ø±
        // ============================================================
        const SYSTEM_PROMPT = `
        You are an expert in Adobe Photoshop scripting and specifically the Photopea API environment.
        Your task is to write valid JavaScript code to execute inside Photopea based on the user's request.
        
        IMPORTANT RULES:
        1. Output ONLY the raw JavaScript code. No markdown blocks (like \`\`\`javascript), no explanations, no conversational text.
        2. Assume a document might or might not be open. If the user asks to create something, start with creating a document.
        3. Photopea uses the Photoshop DOM model.
        
        Common Photopea API Commands (Use these as reference):
        - Create Document: app.documents.add(800, 600, 72, "MyDocument");
        - Get Active Layer: var layer = app.activeDocument.activeLayer;
        - Add Layer: app.activeDocument.artLayers.add();
        - Layer Type: layer.kind = LayerKind.TEXT; (or LayerKind.NORMAL)
        - Text Content: layer.textItem.contents = "Hello World";
        - Text Color: layer.textItem.color.rgb.hexValue = "FF0000";
        - Select All: app.activeDocument.selection.selectAll();
        - Fill Color: app.activeDocument.selection.fill(app.foregroundColor); // or new SolidColor()
        - Create Rectangle: var shape = app.activeDocument.pathItems.rectangle(y, x, width, height); shape.fillPath = ...
        
        Example Request: "Make red background"
        Example Code:
        var bg = app.activeDocument.artLayers.add();
        bg.name = "Background";
        var fillColor = new SolidColor();
        fillColor.rgb.hexValue = "FF0000";
        app.activeDocument.selection.selectAll();
        app.activeDocument.selection.fill(fillColor);
        app.activeDocument.selection.deselect();
        `;

        // ============================================================
        // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
        // ============================================================
        const chatLog = document.getElementById('chat-log');
        const codeOutput = document.getElementById('code-output');
        const promptInput = document.getElementById('promptInput');
        const apiKeyInput = document.getElementById('apiKey');
        const sendBtn = document.getElementById('sendBtn');
        const runBtn = document.getElementById('runBtn');

        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸
        if(localStorage.getItem('photopea_gemini_key')) {
            apiKeyInput.value = localStorage.getItem('photopea_gemini_key');
        }

        function saveKey() {
            localStorage.setItem('photopea_gemini_key', apiKeyInput.value);
            showToast("ØªÙ… Ø­ÙØ¸ Ù…ÙØªØ§Ø­ API");
        }

        function log(text, type) {
            const msg = document.createElement('div');
            msg.className = 'msg ' + type;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶
            let displayText = text;
            if (type === 'ai') {
                displayText = "ğŸ¤– " + text; 
            }
            
            msg.innerText = displayText;
            chatLog.appendChild(msg);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============================================================
        // 3. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Gemini 1.5 Flash)
        // ============================================================
        async function handleRequest() {
            const apiKey = apiKeyInput.value.trim();
            const userText = promptInput.value.trim();

            if (!apiKey) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Google Gemini API Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            if (!userText) return;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            log(userText, 'user');
            promptInput.value = '';
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©... <span class="spinner"></span>';
            runBtn.disabled = true;
            codeOutput.innerText = "// Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯...";

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ gemini-1.5-flash Ø§Ù„Ù…ØªØ·ÙˆØ± ÙˆØ§Ù„Ø³Ø±ÙŠØ¹
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: SYSTEM_PROMPT + "\n\nUser Request: " + userText }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error("API Error: " + data.error.message);
                }

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø±Ø¯
                const rawResponse = data.candidates[0].content.parts[0].text;
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ (Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù…ÙŠØ² Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø±ØºÙ… Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¯Ù… ÙƒØªØ§Ø¨ØªÙ‡Ø§)
                let cleanCode = rawResponse.replace(/```javascript/g, "").replace(/```/g, "").trim();
                
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Øµ Ø®Ø§Ø±Ø¬ Ø§Ù„ÙƒÙˆØ¯ (Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ)
                cleanCode = cleanCode.replace(/^(?!.*(var|function|app\.|document\.)).*/gm, '').trim();

                if (cleanCode.length < 10) {
                    throw new Error("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ù† ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ØµØ§Ù„Ø­.");
                }

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                codeOutput.innerText = cleanCode;
                log("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­.", "system");
                runBtn.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„

            } catch (error) {
                log("Ø®Ø·Ø£: " + error.message, 'system');
                codeOutput.innerText = "// Ø­Ø¯Ø« Ø®Ø·Ø£:\n" + error.message;
                console.error(error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = 'Ø¥Ø±Ø³Ø§Ù„ ğŸš€';
            }
        }

        // ============================================================
        // 4. Ø§Ù„ØªÙ†ÙÙŠØ° Ø¯Ø§Ø®Ù„ Photopea
        // ============================================================
        function runPhotopeaScript() {
            const code = codeOutput.innerText;
            if (!code || code.startsWith("//")) return;

            // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Photopea Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© Ø¯Ø§Ø®Ù„Ù‡ (Plugin mode)
            // Ø£Ùˆ Ø¹Ø¨Ø± postMessage Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ù…Ù†ÙØµÙ„Ø©
            
            log("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ø¥Ù„Ù‰ Photopea...", "system");

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ù… (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙƒÙ€ iframe Ø¯Ø§Ø®Ù„ Photopea)
            try {
                window.parent.postMessage(code, "*");
                showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Photopea");
            } catch (e) {
                console.error(e);
                showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹");
            }
        }

        function copyCode() {
            const code = codeOutput.innerText;
            navigator.clipboard.writeText(code).then(() => {
                showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø­Ø§ÙØ¸Ø©");
            });
        }

        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        promptInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleRequest();
            }
        });
    </script>
</body>
</html>
